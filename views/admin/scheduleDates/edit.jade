include ../../mixins/addressSelector
include parts/form
include ../includes/formToolbar
include ../includes/formElements

extend ../layout

block toolbar
    +formToolbar

append javascripts
    script(src="/javascripts/scheduleDayForm.js")
    script.
        $(function(){
            var validationRules = {
                dateField: 'empty',
                startTime: 'empty',
                endTime: 'empty',
                location: 'empty'
            }

            var $form =  $('form[name=mainForm]')

            // CREATE / SAVE
            $form.form({
                fields: validationRules,
                inline : false,
                onSuccess: function(event, fields){
                    $.ajax({
                        type: '#{formMethod}',
                        data: fields,
                        url: '#{apiItem}',
                        dataType: 'JSON',
                        statusCode: {
                            201: function(data, textStatus, jqXHR) {
                                console.log('201 Error')
                                $.get('/message/success/Saved successfully')
                            }
                        }
                    })
                    .error(function(response) {
                        toaster('error', 'Error: ' + JSON.parse(response.responseText).error)
                    })
                    .done(function(response) {
                        location.replace('#{editAction}' + response.data.id)
                    })
                    return false
                }
            })

            $('.ui.delete.modal').modal({
                onApprove: function(){
                    $.ajax({
                        type: 'delete',
                        data:  $form.form('get values'),
                        url: '#{apiItem}#{data.id}',
                        dataType: 'JSON',
                        statusCode: {
                            204: function() {
                                $.get('/message/success/Deleted successfully')
                            },
                            501: function() {
                                $.get('/message/error/Error deleting')
                            }
                        }
                    })
                    .done(function(response) {
                        location.replace('#{listAction}')
                    })
                }
            })
            $form.find('.delete.button').click(function(){
                $('.ui.delete.modal').modal('show')
            })

            $('#dateField').daterangepicker(
              {
                format: 'MM/DD/YYYY',
                startDate: new Date(),
                singleDatePicker: true,
                timePicker: false
              }
            )

            // Timepicker
            $form.find('#startTime').timepicker({
                minTime: '5:00am',
                maxTime: '12:00am',
                match: 'text',
                useSelect: true,
                noneOption: ' ',
                className: 'ui selection dropdown'
            })
            var endTimeField = $form.find('#endTimeField')
            endTimeField.find('#endTime').timepicker({
                minTime: '5:00am',
                maxTime: '12:00am',
                match: 'text',
                useSelect: true,
                noneOption: ' ',
                className: 'ui selection dropdown',
                showDuration: true
            })
            $('#startTime').on('changeTime', function() {
                // Get selected time
                var out = moment($(this).timepicker('getTime')).add(1, 'h').format('h:mma')
                // Set hidden field
                endTimeField.find('#endTime').val(out)
                endTimeField.find('#endTime').timepicker('setTime', out)
                endTimeField.find('#endTime').timepicker('option', { minTime: $(this).timepicker('getTime') })
                endTimeField.find('.ui-timepicker-select').dropdown()
            })
            $form.find('.ui-timepicker-select').dropdown()

            $('.addressSelector').search(localAddressSearch)
        })

append appContent

    form.ui.form(name='mainForm')

        +mainFormWrapper

            +formSegment

                +scheduleDayDateTime(data)

            +formSegment

                +locationSelector(data)

            div(style='display: none;')
                input#PreventChromeAutocomplete(type='text', name='PreventChromeAutocomplete', autocomplete='address-level4')
                input(type="hidden", name="id", value=data.id)

        +messageContainer
